app.factory('indexedDBDataSvc', function($window, $q){
        console.log('factory loaded....');
        var indexedDB = $window.indexedDB;
        var db=null;
        var lastIndex=0;

        var open = function(){
            var deferred = $q.defer();
            var version = 1;
            var request = indexedDB.open("menus", version);
            request.onupgradeneeded = function(e) {
                db = e.target.result;
                e.target.transaction.onerror = indexedDB.onerror;
                if(!thisDB.objectStoreNames.contains("menus")) {
                    thisDB.createObjectStore("menus", { autoIncrement: true });
                }
            };
            request.onsuccess = function(e) {
                console.log('DB opened....');
                db = e.target.result;
                deferred.resolve();
            };
            request.onerror = function(){
                deferred.reject();
            };

            return deferred.promise;
        };

        var getMenus = function(){
            var deferred = $q.defer();

            var tempMenus =[];
            if(db === null){
                deferred.reject("IndexDB is not opened yet!");
            }
            else{
                var objectStore = db.transaction(["menus"]).objectStore("menus");

                // Get everything in the store;
                objectStore.openCursor().onsuccess = function(e) {
                    var result = e.target.result;
                    if(result)
                    {

                        tempMenus.push(result.value.menu);
                        console.log(result.value.menu);
                        if(result.value.id > lastIndex){
                            lastIndex=result.value.id;
                        }
                        result.continue();
                    }
                    else{
                        console.log('No more entries...');
                        deferred.resolve(menus);

                    }
                };

                objectStore.openCursor().onerror = function(e){
                    console.log(e.value);
                    deferred.reject("Something went wrong!!!");
                };
            }
            console.log(tempMenus);
            return tempMenus;
        };

        var addMenu = function(menu){
            var deferred = $q.defer();

            if(db === null){
                deferred.reject("IndexDB is not opened yet!");
            }
            else{
                var trans = db.transaction(["menus"], "readwrite");
                var store = trans.objectStore("menus");
                lastIndex++;
                var request = store.put({
                    "id": lastIndex,
                    "menu": menu
                });

                request.onsuccess = function(e) {
                    deferred.resolve();
                    deferred.reject("Menu item has been added!");
                };

                request.onerror = function(e) {
                    console.log(e.value);
                    deferred.reject("Menu item couldn't be added!");
                };
            }
            return deferred.promise;
        };
        return{
            open: open,
            getMenus: getMenus,
            addMenu: addMenu,
        };
    });